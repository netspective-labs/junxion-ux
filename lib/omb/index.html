<!doctype html>
<!--
  Object Model Builder (OMB) Playground

  Left: README.md rendered via zero-md (GitHub-flavored markdown + Mermaid fences)
  Right: tabs
    - Original XML: serialized live from the DOM and highlighted with highlight.js
    - Transformed JSON: OMB model rendered with json-viewer
-->
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Object Model Builder (OMB) Playground</title>

  <!-- Mermaid (for ```mermaid fences rendered by zero-md) -->
  <script type="module">
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
    window.mermaid = mermaid;
    mermaid.initialize({ startOnLoad: true });
  </script>

  <!-- zero-md (auto-registers <zero-md>) -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/zero-md@3?register"></script>

  <!-- highlight.js (XML syntax highlighting) -->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github-dark.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/xml.min.js"></script>

  <!-- json-viewer (UMD bundle; NOT the ESM dist that throws "import outside module") -->
  <script src="https://unpkg.com/@alenaksu/json-viewer@2.1.2/dist/json-viewer.bundle.js"></script>

  <style>
    :root {
      color-scheme: light dark;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: #f7fbfb;
    }

    header {
      padding: 10px 14px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(6px);
    }

    header .title {
      font-weight: 650;
      font-size: 18px;
    }

    header button {
      font: inherit;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid rgba(0, 0, 0, 0.25);
      background: transparent;
      cursor: pointer;
    }

    main {
      display: grid;
      grid-template-columns: 1fr 1fr;
      height: calc(100vh - 52px);
    }

    .pane {
      overflow: auto;
      padding: 16px;
    }

    .left {
      border-right: 1px solid rgba(0, 0, 0, 0.15);
      background: rgba(255, 255, 255, 0.75);
    }

    .right {
      background: rgba(248, 250, 252, 0.75);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .tabs {
      display: inline-flex;
      border: 1px solid rgba(0, 0, 0, 0.18);
      border-radius: 10px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.55);
      align-self: flex-start;
    }

    .tabs button {
      font: inherit;
      border: 0;
      padding: 8px 10px;
      background: transparent;
      cursor: pointer;
      color: rgba(15, 23, 42, 0.85);
    }

    .tabs button+button {
      border-left: 1px solid rgba(0, 0, 0, 0.12);
    }

    .tabs button.active {
      background: rgba(15, 23, 42, 0.08);
      font-weight: 650;
    }

    .hint {
      margin: 0;
      color: rgba(0, 0, 0, 0.65);
      font-size: 13px;
    }

    .tab-content {
      display: none;
      flex: 1 1 auto;
      min-height: 0;
    }

    .tab-content.active {
      display: block;
    }

    /* XML display */
    pre {
      margin: 8px 0 0;
      background: #0b1020;
      border-radius: 12px;
      padding: 12px;
      overflow: auto;
      height: calc(100vh - 160px);
    }

    pre code {
      display: block;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      line-height: 1.45;
    }

    /* JSON viewer styling */
    json-viewer {
      display: block;
      height: calc(100vh - 160px);
      overflow: auto;
      border-radius: 12px;
      padding: 12px;

      --background-color: #0b1020;
      --color: #e6eaf2;

      --font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      --font-size: 0.95rem;
      --line-height: 1.45rem;
      --indent-size: 1.1em;

      --indentguide-color: rgba(255, 255, 255, 0.08);
      --indentguide-color-active: rgba(255, 255, 255, 0.18);

      --string-color: #a3eea0;
      --number-color: #d19a66;
      --boolean-color: #4ba7ef;
      --null-color: #df9cf3;
      --property-color: #9bbad1;

      --preview-color: #deae8f;
      --highlight-color: #ff4d4d;
    }

    json-viewer::part(row) {
      margin: 2px 0;
    }

    json-viewer::part(children) {
      padding-left: 0.35em;
    }

    /* Dim structural keys */
    json-viewer::part(property)[data-key=".tag"],
    json-viewer::part(property)[data-key=".children"] {
      color: rgba(180, 190, 205, 0.55);
      font-style: italic;
    }

    @media (prefers-color-scheme: dark) {
      header {
        border-bottom-color: rgba(255, 255, 255, 0.14);
        background: rgba(15, 23, 42, 0.7);
      }

      header button {
        border-color: rgba(255, 255, 255, 0.22);
      }

      .left {
        border-right-color: rgba(255, 255, 255, 0.14);
        background: rgba(15, 23, 42, 0.55);
      }

      .right {
        background: rgba(2, 6, 23, 0.55);
      }

      .hint {
        color: rgba(255, 255, 255, 0.65);
      }

      .tabs {
        border-color: rgba(255, 255, 255, 0.16);
        background: rgba(15, 23, 42, 0.35);
      }

      .tabs button {
        color: rgba(226, 232, 240, 0.85);
      }

      .tabs button+button {
        border-left-color: rgba(255, 255, 255, 0.12);
      }

      .tabs button.active {
        background: rgba(226, 232, 240, 0.12);
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="title">Object Model Builder (OMB) Playground</div>

    <div style="display:flex; align-items:center; gap:12px;">
      <label style="display:flex; align-items:center; gap:8px; font: inherit;">
        <input id="toggleTags" type="checkbox" checked />
        Show <code>.tag</code> meta data
      </label>

      <button id="rebuildBtn" type="button">Rebuild</button>
    </div>
  </header>


  <main>
    <div class="pane left">
      <zero-md src="./README.md"></zero-md>
    </div>

    <div class="pane right">
      <div class="tabs" role="tablist" aria-label="Right panel">
        <button id="tabXml" class="active" type="button" role="tab" aria-selected="true">Original XML</button>
        <button id="tabJson" type="button" role="tab" aria-selected="false">Transformed JSON</button>
      </div>

      <div id="panelXml" class="tab-content active" role="tabpanel">
        <p class="hint">Serialized live from the DOM and highlighted with highlight.js</p>
        <pre><code id="xmlCode" class="language-xml"></code></pre>
      </div>

      <div id="panelJson" class="tab-content" role="tabpanel">
        <p class="hint">Sanitized OMB model (JSON.stringify / parse)</p>
        <json-viewer id="jsonViewer"></json-viewer>
      </div>
    </div>
  </main>

  <!-- Example markup under <my-element> -->
  <my-element id="ombRoot" root-attr-1="root-attr-1-text-in-attr"
    xmlns:xdm="http://www.netspective.org/Framework/Commons/XMLDataModel">
    PCDATA in root.

    <root-attr-1>root-attr-1-text</root-attr-1>

    <test-boolean>yes</test-boolean>
    <path-separator-char>:</path-separator-char>
    <test-byte>96</test-byte>
    <test-short>128</test-short>
    <test-long>1234567890</test-long>
    <test-float>3.1415926535</test-float>
    <test-double>3.1415926535897932384626433</test-double>
    <test-file>DataModelSchemaTest.xml</test-file>
    <test-string-array>item1, item2, item3</test-string-array>

    <xdm:include file="DataModelSchemaTest-include.xml"></xdm:include>

    <nested1 text="TestText1" integer="1" boolean="yes">
      PCDATA in nested1.

      <nested11 text="TestText11" integer="11"></nested11>

      <nested11>
        <type>type-C</type>
        <text>TestText12</text>
        <integer>12</integer>
      </nested11>

      <nested11 class="com.netspective.commons.xdm.DataModelSchemaTest$CustomNested11Test" text="CustomTestText12"
        integer="122" bit-mask="BIT_THREE | BIT_FIVE | BIT_EIGHT" bit-three="on" bit-ten="on"></nested11>
    </nested1>
  </my-element>

  <script type="module">
    import { ObjectModelBuilderElement, defaultTypedValue } from "./omb.js";

    class MyElement extends ObjectModelBuilderElement {
      constructor() {
        super({ typedValue: (raw, tag) => defaultTypedValue(raw, tag) });
      }
    }
    if (!customElements.get("my-element")) customElements.define("my-element", MyElement);

    const root = /** @type {any} */ (document.querySelector("#ombRoot"));
    const xmlCode = /** @type {HTMLElement} */ (document.querySelector("#xmlCode"));
    const jsonViewer = /** @type {any} */ (document.querySelector("#jsonViewer"));
    const rebuildBtn = /** @type {HTMLButtonElement} */ (document.querySelector("#rebuildBtn"));

    const tabXml = /** @type {HTMLButtonElement} */ (document.querySelector("#tabXml"));
    const tabJson = /** @type {HTMLButtonElement} */ (document.querySelector("#tabJson"));
    const panelXml = document.querySelector("#panelXml");
    const panelJson = document.querySelector("#panelJson");
    const toggleTags = /** @type {HTMLInputElement} */ (document.querySelector("#toggleTags"));

    function setTab(which) {
      const xmlActive = which === "xml";
      tabXml.classList.toggle("active", xmlActive);
      tabJson.classList.toggle("active", !xmlActive);
      tabXml.setAttribute("aria-selected", String(xmlActive));
      tabJson.setAttribute("aria-selected", String(!xmlActive));
      panelXml.classList.toggle("active", xmlActive);
      panelJson.classList.toggle("active", !xmlActive);
    }

    tabXml.addEventListener("click", () => setTab("xml"));
    tabJson.addEventListener("click", () => setTab("json"));

    function formatXml(xml) {
      const reg = /(>)(<)(\/*)/g;
      const xmlStr = xml.replace(reg, "$1\n$2$3");
      const padChar = "  ";
      let pad = 0;
      return xmlStr.split("\n").map((line) => {
        if (line.match(/^<\//)) pad = Math.max(pad - 1, 0);
        const indent = padChar.repeat(pad);
        if (line.match(/^<[^!?].*[^/]>$/) && !line.startsWith("</") && !line.includes("/>") && !line.match(/^<.*>.*<\/.*>$/)) {
          pad += 1;
        }
        return indent + line;
      }).join("\n");
    }

    function renderXml() {
      const raw = new XMLSerializer().serializeToString(root);
      xmlCode.textContent = formatXml(raw);
      // highlight.js marks nodes as already highlighted; clear that so rebuilds re-highlight.
      if (xmlCode.dataset) delete xmlCode.dataset.highlighted;
      const doHighlight = () => {
        if (window.hljs && window.hljs.highlightElement) {
          window.hljs.highlightElement(xmlCode);
          return true;
        }
        return false;
      };
      // If highlight.js is still loading, retry shortly.
      if (!doHighlight()) setTimeout(doHighlight, 50);
    }

    function renderJson() {
      const model = root.model ?? root.rebuild();
      const viewModel = model.toJSON({ withTags: toggleTags.checked });
      jsonViewer.data = JSON.parse(JSON.stringify(viewModel));
      if (jsonViewer.collapseAll) jsonViewer.collapseAll();
      else if (jsonViewer.expandAll) jsonViewer.expandAll();
    }

    function renderAll() {
      renderXml();
      renderJson();
    }

    root.addEventListener("omb:built", () => {
      // rebuild() triggers this; keep the right tab data fresh regardless of which tab is showing
      renderAll();
    });

    rebuildBtn.addEventListener("click", () => root.rebuild());
    toggleTags.addEventListener("change", renderJson);

    renderAll();
    queueMicrotask(renderAll);
    setTimeout(renderAll, 0);
  </script>
</body>

</html>